"use strict";angular.module("hyenaAppsApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ngStorage","firebase","angularMoment","angularFileUpload","hyenaAngular"]).config(["$routeProvider","$locationProvider",function(a,b){a.when("/",{templateUrl:"views/main.html",controller:"DashboardCtrl"}).when("/app/new",{templateUrl:"views/new.html",controller:"NewCtrl"}).when("/upload",{template:"",controller:function(){console.log("Upload controller")}}).when("/app/:appId",{templateUrl:"views/app.html",controller:"AppCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]).config(["$httpProvider",function(a){a.interceptors.push(["$injector",function(a){return a.get("AuthInterceptor")}])}]).constant("FBURL","https://hyena-apps.firebaseio.com/").constant("APIKEY","NDBlZGMyZTNmZWU0YzQzYTkwMGRiZTA5").constant("APIPATH","http://st-studio.unl.edu/hyena_platform/public/api/1.0/").constant("PLATFORM_ROOT","http://st-studio.unl.edu/hyena_platform/public/").constant("angularMomentConfig",{}).constant("AUTH_EVENTS",{loginSuccess:"auth-login-success",loginFailed:"auth-login-failed",logoutSuccess:"auth-logout-success",sessionTimeout:"auth-session-timeout",notAuthenticated:"auth-not-authenticated",notAuthorized:"auth-not-authorized"}).constant("USER_ROLES",{all:"*",admin:"admin",editor:"editor",guest:"guest"}),angular.module("hyenaAppsApp").controller("ApplicationCtrl",["$rootScope","$scope","$location","$window","$routeParams","$firebase","AuthService","UserService","AppFirebase","Notification","FBURL","AUTH_EVENTS",function(a,b,c,d,e,f,g,h,i,j,k,l){if(b.appLoaded=null,b.currentUser=null,a.currentGroupId=0,angular.isDefined(c.search().token)){var m=c.search().token;c.url(c.path());{i.authenticate(m).then(function(a){g.manualLogin(a.uid,m,"apps").then(function(a){b.appLoaded=!0,b.currentUser=a.data},function(a){console.log("Login failed:",a)})},function(a){console.error("Login failed:",a)})}}else g.check()&&null!==i.getAuthRef().$getAuth()?g.user("apps").then(function(a){b.appLoaded=!0,b.currentUser=a.data}):(g.login(),j.showModal("Please log in","#modal-content-login","takeover"));b.$watch("currentUser",function(a,b){null===b||!angular.isUndefined(a)&&null!==a?null!==b&&j.hideModal():j.showModal("Please log in","#modal-content-login","takeover")}),a.$on(l.notAuthenticated,function(){g.expire(),b.currentUser=null,g.login()}),b.setCurrentUser=function(a){b.currentUser=a},b.logOutCurrentUser=function(){b.currentUser=null,g.logout()},b.logIn=function(){g.check()||g.login()},b.toggleMainDrawer=function(){document.querySelector("unl-layout").toggleDrawer()},b.closeMainDrawer=function(){document.querySelector("unl-layout").closeDrawer()},b.showLoginWindow=function(){j.setModalContent("#modal-content-login")},b.closeModal=function(){j.hideModal()},b.go=function(a,e){b.pageAnimationClass="undefined"==typeof e?"animate-slide-right":e,"back"===a?(b.pageAnimationClass="animate-slide-left",d.history.back()):c.path(a)}}]),angular.module("hyenaAppsApp").controller("DashboardCtrl",["$rootScope","$scope","$routeParams","GroupService","Notification",function(){}]),angular.module("hyenaAppsApp").service("GroupService",["APIPATH","APIKEY","$http","$firebase","AppFirebase",function(a,b,c,d,e){var f=e.getRef().child("groups"),g={get:function(d,e){return angular.isUndefined(e)&&(e=""),c.get(a+"groups/"+d+"?with="+e+"&api_key="+b)},exists:function(a){var b=d(f.child(a)).$asObject();return b.$loaded(function(){return null!==b.$value})},add:function(a,b){return d(f).$set(b,a)},addUser:function(d,e){return c.post(a+"groups/"+d+"/users?api_key="+b,{users:[e]})},hasUser:function(d,e){return c.get(a+"groups/"+d+"/users/"+e+"?api_key="+b)},existsOrAdd:function(a){var b=g.exists(a);b.then(function(b){if(!b){var c=g.get(a);c.then(function(b){var c={title:b.data.title,description:b.data.description};g.add(c,a).then(function(a){console.log("Group added to Firebase",a)})})}})}};return g}]),angular.module("hyenaAppsApp").service("AppService",["$http","$upload","PLATFORM_ROOT","AuthService",function(a,b,c,d){var e="?token="+d.authToken();return{get:function(b){return a.get(c+"apps/"+b+e)},update:function(b,d){return a.put(c+"apps/"+b+e,d)},add:function(b){return a.post(c+"apps"+e,b)},remove:function(b){return a.delete(c+"apps/"+b+e)},uploadImage:function(a,d){return b.upload({url:c+"apps/"+a+"/image"+e,method:"POST",file:d})}}}]),angular.module("hyenaAppsApp").controller("AppCtrl",["$scope","$routeParams","AppService","Notification","PLATFORM_ROOT",function(a,b,c,d,e){a.appSettingsForm={};var f=parseInt(b.appId);c.get(f).then(function(b){a.app=b.data}),a.uploadTarget=e+"apps/"+f+"/image",a.$watch("app",function(b,c){angular.isDefined(c)&&null!==b&&b!==c&&a.appSettingsForm.$valid&&a.updateApp()},!0),a.$watch("app_icon_file",function(b){if(angular.isDefined(b)){console.log(b[0]);var e=c.uploadImage(f,b[0]);e.progress(function(a){console.log("progress: "+parseInt(100*a.loaded/a.total)+"% file :"+a.config.file.name)}).success(function(b){a.app.icon_url=b.uploaded_file;for(var c=0;c<a.currentUser.apps.length;c++)if(a.currentUser.apps[c].id===f){a.currentUser.apps[c].icon_url=b.uploaded_file;break}}).error(function(a){d.show("Sorry! There was an error uploading that image.","error"),console.log("Icon upload failed:",a)})}}),a.updateApp=function(){c.update(f,a.app).then(function(){for(var b=0;b<a.currentUser.apps.length;b++)if(a.currentUser.apps[b].id===f){a.currentUser.apps[b]=a.app;break}},function(){d.show("Sorry! There was an error updating your app.","error")})},a.removeApp=function(){c.remove(f).then(function(){for(var b=0;b<a.currentUser.apps.length;b++)if(a.currentUser.apps[b].id===f){a.currentUser.apps.splice(b,1);break}a.go("/","animate-slide-left"),d.show("Your app has been removed.","success")},function(a){console.log("Error removing app",a),d.show("Sorry! There was an error removing your app.","error")})},a.showRemoveModal=function(){d.showModal("Remove App?","#modal-delete-confirm")}}]),angular.module("hyenaAppsApp").controller("NewCtrl",["$scope","AppService","Notification",function(a,b,c){a.app={},a.createApp=function(){b.add(a.app).then(function(b){var d=b.data.id;a.app.active=1,a.currentUser.apps.push(a.app),a.go("app/"+d),c.show("Your app has been created successfully!","success")},function(a){console.log("Create App Error",a),c.show("There was an error creating your app.","error")})}}]);